## 现状结论
- 当前小票预览/打印不会显示会员信息与余额：小票文本生成在 [Cashier.vue](file:///Users/lv/Workspace/erp/jshERP-web/src/views/cashier/Cashier.vue) 的 `buildReceiptText`，只拼了门店/座位/明细/金额/支付方式。
- 但后端其实已经能返回会员对象：`/cashier/session/detail` 的返回里包含 `member`（类型是 Supplier），并且带 `advanceIn` 字段（会员预付款/储值余额）。来源是 [CashierSessionService.getDetail](file:///Users/lv/Workspace/erp/jshERP-boot/src/main/java/com/jsh/erp/service/cashier/CashierSessionService.java#L70-L131) 中 `supplierMapper.selectByPrimaryKey`。
- “余额多少”可以直接展示：`member.advanceIn` 就是当前余额（表 `jsh_supplier.advance_in`）。
- “本次消费后余额多少”目前不可靠：因为我们现在的收银结算只落库了支付拆分与发票申请，并未把“储值卡/预付款支付”同步到会员余额计算链路。
  - 现有余额计算口径在 [SupplierService.updateAdvanceIn](file:///Users/lv/Workspace/erp/jshERP-boot/src/main/java/com/jsh/erp/service/SupplierService.java#L282-L300)：`advanceIn = 收预付款总额 - 预付款消费总额`。
  - “预付款消费总额”目前只统计了零售出库（pay_type=预付款），不会自动包含我们新加的收银结算。

## 目标
- 小票支持显示会员信息（姓名/电话等）与“结算时余额”。
- 若本次结算选择了“储值卡(CARD)”支付：
  - 小票显示：本次储值支付金额、结前余额、结后余额。
  - 同步更新会员余额（确保后续再查会员余额是扣减后的）。

## 实现方案（推荐：把收银结算纳入余额口径）
### 1) 后端：新增“收银结算储值消费”汇总 SQL
- 在 `CashierSettlementPaymentMapper` 或新建 `CashierSettlementPaymentMapperEx` 增加方法：按 `member_id` 汇总 `pay_method='CARD'` 且结算单 `status='PAID'` 且未删除的金额。
- SQL 需 join `jsh_cashier_settlement_payment` + `jsh_cashier_settlement`（用 `settlement_id` 关联），并依赖现有租户插件自动加 tenant 条件（不要手动拼 tenant_id 字段到 insert/select，避免重复）。

### 2) 后端：扩展会员余额计算
- 修改 [SupplierService.updateAdvanceIn](file:///Users/lv/Workspace/erp/jshERP-boot/src/main/java/com/jsh/erp/service/SupplierService.java#L282-L300)：
  - `advanceIn = financialAllPrice - (billAllPrice + cashierPrepaidUsed)`
  - 其中 `cashierPrepaidUsed` 来自第 1 步的新 SQL。

### 3) 后端：结算时校验与刷新余额
- 修改 [CashierSettlementService.checkout](file:///Users/lv/Workspace/erp/jshERP-boot/src/main/java/com/jsh/erp/service/cashier/CashierSettlementService.java)：
  - 若 `payments` 里存在 `pay_method='CARD'` 且金额>0：
    - 必须有 `memberId`；否则返回“储值支付必须选择会员”。
    - 校验 `member.advanceIn >= 本次CARD金额`；不足则拒绝结算。
  - 结算成功写入后，调用 `supplierService.updateAdvanceIn(memberId)` 以刷新余额。
  - 返回值中补充：`member`（姓名/电话/余额）、`prepaidUsedAmount`（本次CARD金额）、`balanceBefore`、`balanceAfter`，供前端小票直接展示。

## 前端改造
### 4) 小票文本增加会员信息与余额段
- 修改 [Cashier.vue](file:///Users/lv/Workspace/erp/jshERP-web/src/views/cashier/Cashier.vue) 的 `buildReceiptText`：
  - 若 `data.member` 存在：显示 `会员：{supplier}(电话phoneNum)`。
  - 显示 `结前余额 / 本次储值支付 / 结后余额`（没有储值支付则仅显示“余额：xxx”）。

### 5) 结算页交互优化（可选）
- 在结算页若输入了“储值卡”金额但未选择会员，按钮禁用并提示。

## 验证方式
- 本地创建会话并选择会员（会员需有 `advanceIn>0`）。
- 用“储值卡(CARD)”支付部分金额完成结算：
  - 小票显示会员与余额变动。
  - 再次查询会员信息（或收银再开单查看 member.advanceIn）确认余额已扣减。
- 不使用储值卡支付时：小票仅展示会员信息与当前余额。

## 影响范围说明
- 只影响“会员预付款余额”的计算口径，新增把“收银结算中的储值卡支付”纳入扣减项；不会改变现有零售/财务模块的逻辑。