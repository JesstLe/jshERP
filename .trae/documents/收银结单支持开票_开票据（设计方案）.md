## 现状核查（与你提出的“支付方式拆分”相关）
- 目前收银结算只做“金额汇总 + 可选清台”，**没有记录任何支付方式拆分**。
  - 前端“结算”页只显示项目金额/产品金额/合计，没有支付输入区 [CashierDeskModal.vue](file:///Users/lv/Workspace/erp/jshERP-web/src/views/cashier/modules/CashierDeskModal.vue#L150-L165)。
  - 后端结算接口 `/cashier/settlement/checkout` 仅接收 `sessionId/clearSeat`，不含付款方式字段 [CashierSettlementController](file:///Users/lv/Workspace/erp/jshERP-boot/src/main/java/com/jsh/erp/controller/CashierSettlementController.java#L44-L59)，结算服务也仅返回汇总并关会话 [CashierSettlementService](file:///Users/lv/Workspace/erp/jshERP-boot/src/main/java/com/jsh/erp/service/cashier/CashierSettlementService.java#L40-L52)。
- 目前“消费内容选择”已经具备：收银台可添加**服务项目**与**产品**，并会在明细里汇总展示（已满足你说的“结算时应把消费内容都选中”）[CashierDeskModal.vue](file:///Users/lv/Workspace/erp/jshERP-web/src/views/cashier/modules/CashierDeskModal.vue#L452-L499)。

## 你这个行业（足浴修脚店）票据应该长什么样（模板设计）
### 1）票据类型（建议两种）
- **消费小票/收据（现场必需）**：结单立即打印，给顾客留存。
- **发票申请单（现场采集信息）**：前台采集抬头/税号/邮箱，财务后续税控系统开具并发送；系统里留痕、可回填发票号与PDF。

### 2）消费小票/收据内容结构（包含你要求的“项目+产品+付款方式拆分”）
- 门店信息：店名、门店（分店名）、电话（可选）、地址（可选）
- 订单信息：订单号/会话号、结账时间、座位/包间、收银员
- 消费明细（两段或合并显示）：
  - 项目：项目名称、数量/时长、单价、小计（可选：技师）
  - 产品：产品名称、数量、单价、小计
- 金额汇总：项目合计、产品合计、优惠/抹零（预留）、应收、实收、找零
- 付款方式拆分：现金、微信、支付宝、银行卡/POS、会员卡/储值、挂账/签单（如启用）
- 会员信息（如绑定）：会员号/手机号（脱敏）、本次积分/余额变动（可选）
- 底部：声明（消费凭证/售后依据）、二维码（可选：评价/加企微/订单查询）

### 3）发票申请单内容（尽量少填，符合门店现场）
- 抬头类型：个人/企业
- 抬头名称（必填）
- 税号（企业必填）
- 接收邮箱（电子发票必填）
- 开票内容（默认：服务费/服务费*1，可配置）
- 开票金额（默认取本单应收）
- 关联订单号、门店、时间、收银员
- 状态：待开票/已开票/驳回；已开票可回填发票号并上传PDF

## 功能落地设计（你关心的两点如何实现）
### A. 消费明细：项目 + 产品
- 数据来源：以结单时刻的“会话明细”作为快照，包含：
  - 服务项目明细（名称/数量/单价/金额）
  - 产品明细（名称/数量/单价/金额）
- 票据打印/开票申请均使用这份快照，避免后续改单导致票据内容漂移。

### B. 支付方式拆分（当前无，需要新增）
- 在收银“结算”Tab中新增“支付明细录入区”，默认展示：
  - 现金、微信、支付宝、银行卡/POS、储值卡、挂账（可按门店启用配置显示）
- 交互规则：
  - 默认把“合计金额”自动填到一个默认支付方式（例如微信）
  - 支持多种方式混合，校验“各方式合计 = 应收金额”；若不相等提示差额
  - 找零：仅当现金大于应收时显示（找零=现金-应收）
- 提交时把 `payments[]` 一起发给后端结单接口并落库。

## 数据库/后端接口设计（核心）
### 1）新增结算记录与支付明细表
- `jsh_cashier_settlement`：结单主表（tenantId/depotId/sessionId/totalAmount/realPayAmount/discountAmount/createdTime/cashierUserId等）
- `jsh_cashier_settlement_payment`：支付方式拆分明细（settlementId/payMethod/amount）
- `jsh_cashier_ticket`：票据打印快照（可与 settlement 合并，也可单独；MVP 建议合并在 settlement 并增加“打印模板字段/打印次数”）
- `jsh_invoice_request`：发票申请单（后续回填发票号与PDF）

### 2）接口改造
- 扩展 `/cashier/settlement/preview`：返回“项目明细+产品明细+合计”，供票据预览与打印。
- 扩展 `/cashier/settlement/checkout`：入参新增 `payments`、`needInvoice`、`invoiceInfo`（若提交发票申请），并在结算事务内：
  - 校验门店权限（沿用现有会话权限）
  - 校验支付拆分金额 = 应收金额
  - 写入 settlement + payment 明细
  - 若 needInvoice：写入 invoice_request
  - 可选清台/关会话（保留现有逻辑）

## 权限与门店隔离
- settlement/票据/发票申请全部带 `depotId` 与 `tenantId`；所有查询/操作按授权门店过滤，禁止跨店查看或篡改。

## 实施步骤（如果你确认要做，我将按此落地）
1. 设计并新增结算/支付/发票申请相关数据表与升级SQL。
2. 改造后端结算接口：支持明细返回 + 支付拆分入参落库 + 发票申请落库。
3. 改造前端收银结算Tab：增加支付方式拆分录入区 + 发票申请弹窗 + 小票预览/打印。
4. 增加后台“发票申请管理”页：查看、标记已开票、上传PDF。
5. 补充验收用例：
  - 项目+产品明细与金额一致
  - 支付拆分合计校验
  - 跨门店越权拦截
  - 重复结单防重（同 sessionId 不能重复生成结算记录）

## 交付的“票据样式”
- 提供两套模板：
  - 热敏小票（58/80mm）
  - A4收据/发票申请单（更正式，便于盖章/存档）
- 模板字段覆盖：项目名称 + 产品名称 + 支付方式拆分 + 订单信息（你要求的细节会全部体现）

注：所有新增代码注释使用中文（符合你的规范）。